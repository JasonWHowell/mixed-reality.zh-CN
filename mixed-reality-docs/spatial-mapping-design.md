---
title: 空间映射设计
description: 在 HoloLens 内有效使用空间映射需要认真考虑许多因素。
author: cre8ivepark
ms.author: dongpark
ms.date: 03/21/2018
ms.topic: article
keywords: Windows Mixed Reality, 设计, 空间映射, HoloLens, 表面重建, 网格
ms.openlocfilehash: 02e64727f9a23bea28e018d7c4e5a8b89c152447
ms.sourcegitcommit: 60f73ca23023c17c1da833c83d2a02f4dcc4d17b
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/17/2019
ms.locfileid: "69566007"
---
# <a name="spatial-mapping-design"></a>空间映射设计

在 HoloLens 内有效使用空间映射需要认真考虑许多因素。

## <a name="device-support"></a>设备支持

<table>
    <colgroup>
    <col width="33%" />
    <col width="33%" />
    <col width="33%" />
    </colgroup>
    <tr>
        <td><strong>功能</strong></td>
        <td><a href="hololens-hardware-details.md"><strong>HoloLens</strong></a></td>
        <td><a href="immersive-headset-hardware-details.md"><strong>沉浸式头戴显示设备</strong></a></td>
    </tr>
     <tr>
        <td>空间映射设计</td>
        <td>✔️</td>
        <td>❌</td>
    </tr>
</table>

## <a name="why-is-spatial-mapping-important"></a>为什么空间映射很重要？

利用空间映射, 可以将对象放置在真实的图面上。 这有助于在用户世界定位对象, 并利用真实的深度提示。基于其他全息影像和现实世界对象 Occluding 全息影像有助于说服用户这些全息影像实际位于其空间中。 在空间中浮动或随用户移动的全息影像并不真实。 如果可能, 可轻松放置项目。

放置或移动全息影像时显示表面 (使用简单的投影网格)。 这将帮助用户了解他们最能最好地放置全息影像, 并在用户尝试放置全息影像的位置上显示用户。 如果用户的角度太多, 您可以向用户 "布告栏项目"。

## <a name="what-influences-spatial-mapping-quality"></a>哪些因素会影响空间映射质量？

[此处](environment-considerations-for-hololens.md)详细介绍的几个因素可能会影响这些错误的频率和严重性。  但是, 你应设计应用程序, 以便即使在空间映射数据中存在错误时, 用户也能够实现其目标。

## <a name="the-environment-scanning-experience"></a>环境扫描体验

使用空间映射的每个应用程序都应考虑提供 "扫描体验";应用程序引导用户扫描应用程序正常运行所必需的表面所使用的过程。

![扫描示例](images/sr-mixedworld-140429-8pm-00068-1000px.png)<br>
*扫描示例*

此扫描体验的性质可能因每个应用程序的需求而有很大差别, 但两个主要原则应指导其设计。

首先,**清除与用户的通信是主要关注**点。 用户应始终知道是否满足应用程序的要求。 如果不满足这些要求, 则应该立即清楚地说明这种情况的原因, 并且应迅速采取适当的措施。

其次,**应用程序应尝试在效率和可靠性之间取得平衡**。 如果可以**可靠地**执行此操作, 则应用程序应自动分析空间映射数据以节省用户时间。 如果无法可靠地执行此操作, 则应用程序应改为允许用户使用其所需的其他信息快速提供应用程序。

若要帮助设计正确的扫描体验, 请考虑以下哪些可能适用于你的应用程序:

* **无扫描体验**
   * 如果没有任何引导式扫描体验, 应用程序可以正常工作;它将了解在自然用户移动过程中观察到的图面。
   * 例如, 允许用户在带有全息喷涂画图的表面上绘图的应用程序只需要知道当前对用户可见的表面。
   * 如果环境中的用户已使用 HoloLens 花费了大量时间, 则可能会完全扫描该环境。
   * 请记住, 空间映射使用的相机只能在用户前面看到 3.1 m, 因此, 空间映射将不知道任何更远的图面, 除非用户在过去从更远的距离观察到它们。
   * 因此, 用户了解已经扫描了哪些表面, 应用程序应提供此效果的视觉反馈, 例如, 将虚拟阴影转换到扫描图面上可能会帮助用户在这些表面上放置全息影像。
   * 对于这种情况, 应将空间图面观察器的边界卷更新为主体锁定的[空间坐标系统](coordinate-systems.md), 使其跟随用户。

* **查找合适的位置**
   * 应用程序可设计为在具有特定要求的位置使用。
   * 例如, 应用程序可能需要用户附近的空白区域, 以便他们能够安全地练习全息 kung-fu。
   * 应用程序应提前向用户传达任何特定要求, 并通过清晰的视觉反馈来强化。
   * 在此示例中, 应用程序应可视化所需空区域的范围, 并以可视方式突出显示此区域内任何不需要的对象的状态。
   * 对于这种情况, 空间图面观察器的边界卷应在所选位置使用世界锁定的[空间坐标系统](coordinate-systems.md)。

* **查找图面的合适配置**
   * 应用程序可能需要特定的图面配置, 例如两个大型、平整、相反的壁, 以创建全息的镜像厅。
   * 在这种情况下, 应用程序需要对空间映射提供的图面进行分析以检测适当的图面, 并将用户定向到它们。
   * 如果应用程序的表面分析不完全可靠, 用户应具有回退选项。 例如, 如果应用程序错误地将门口标识为平整壁, 则用户需要一种简单的方法来更正此错误。

* **扫描部分环境**
   * 应用程序可能希望只捕获用户所指示的部分环境。
   * 例如, 应用程序会扫描房间的某个部分, 以使用户可以为想要销售的家具发布全息保密广告。
   * 在这种情况下, 应用程序应该捕获用户在扫描期间观察到的区域内的空间映射数据。

* **扫描整个聊天室**
   * 应用程序可能需要扫描当前房间中的所有表面, 包括用户之后的所有表面。
   * 例如, 游戏可能将用户作为 Gulliver 的角色, 在 siege 中, 从数百个微小 Lilliputians 接近所有方向。
   * 在这种情况下, 应用程序需要确定当前房间中已经扫描了多少个面, 并指示用户的注视填充了重大间隙。
   * 此过程的关键是提供可视反馈, 使用户清楚地知道尚未扫描哪些表面。 应用程序可以使用[基于距离的雾化](https://msdn.microsoft.com/library/windows/desktop/bb173401%28v=vs.85%29.aspx)来以可视方式突出显示空间映射图面未涵盖的区域。

* **获取环境的初始快照**
   * 在采用初始 "快照" 后, 应用程序可能希望忽略环境中的所有更改。
   * 这可能适用于避免与环境中的初始状态紧密耦合的用户创建数据的中断。
   * 在这种情况下, 在扫描完成后, 应用程序应在其初始状态下生成空间映射数据的副本。
   * 如果在环境中仍有封闭像素, 则应用程序应继续接收空间映射数据的更新。
   * 对于空间映射数据的持续更新, 还允许对已发生的任何更改进行可视化, 并向用户阐明环境以前和当前状态之间的差异。

* **采用用户启动的环境快照**
   * 应用程序可能只希望在用户指示时对环境更改做出响应。
   * 例如, 用户可以通过在不同时刻捕获其姿势来创建多个 3D "statues"。

* **允许用户更改环境**
   * 应用程序可用于实时响应用户环境中所做的任何更改。
   * 例如, 如果在另一侧发生全息部游戏, 则用户绘制窗帘可能会触发 "场景变化"。

* **指导用户避免空间映射数据中的错误**
   * 在用户扫描其环境时, 应用程序可能希望向用户提供指导。
   * 这可以帮助用户避免[空间映射数据中](spatial-mapping-design.md#what-influences-spatial-mapping-quality)出现某些类型的错误, 例如, 远离 sunlit windows 或镜像。

需要注意的另一个细节是, 空间映射数据的 "范围" 是不受限制的。 虽然空间映射确实生成了大量空间的永久数据库, 但它只会使该数据可用于用户周围大小限制较小的应用程序。 因此, 如果从较长的 corridor 开始, 到离开始时间起, 最终空间表面就会消失。 当然, 您可以通过在应用程序从可用空间映射数据中消失后将它们缓存在您的应用程序中来缓解这种情况。

## <a name="mesh-processing"></a>网格处理

它可能有助于检测图面中的常见错误类型, 并根据需要对空间映射数据进行筛选、删除或修改。

请记住, 空间映射数据应尽可能忠实到实际的表面, 因此, 任何正在进行的处理都将进一步从 "真实" 改变你的曲面。

下面是一些可能有用的不同类型网格处理的示例:

* **孔洞填充**
   * 如果导致暗材料的小对象无法扫描, 它将在周围表面上留下一个孔。
   * 孔洞会影响封闭: 在被视为不透明的实际表面, 可以通过 "通过" 洞来查看全息影像。
   * 孔洞会影响 raycasts: 如果使用 raycasts 帮助用户与表面交互, 则这些光线可能不需要通过洞。 一种缓解措施是使用多个 raycasts 的捆绑, 涵盖适当大小的区域。 这将允许你筛选 "离群离群" 结果, 这样即使一个 raycast 通过一个小孔, 聚合结果仍将有效。 但请注意, 这种方法会产生计算成本。
   * 孔洞会影响物理学冲突: 物理学模拟控制的对象可能会贯穿地面的孔, 并会丢失。
   * 可以算法在 surface 网格中填充此类孔。 但是, 您将需要优化算法, 以便不会填充 "real 洞", 如 windows 和两侧。 很难可靠地区分 "实孔" 与 "虚部", 因此您需要试验不同的试探法, 例如 "大小" 和 "边界形状"。

* **删除 Hallucination**
   * 反射、明亮灯光和移动对象可能会使小延迟 "hallucinations" 浮动在空中。
   * Hallucinations 影响封闭: Hallucinations 可能会成为深色形状, 并将其移到上, 并 occluding 其他全息影像。
   * Hallucinations 影响 raycasts: 如果你使用 raycasts 帮助用户与表面交互, 则这些光线可能会碰到 hallucination, 而不是其背后的表面。 与孔洞一样, 一种缓解措施是使用许多 raycasts, 而不是使用单个 raycast, 但这会产生计算成本。
   * Hallucinations 影响物理学冲突: 物理学模拟控制的对象可能会停滞在 hallucination 的位置, 并且无法在看似清晰的空间区域中移动。
   * 可以从 surface 网格筛选此类 hallucinations。 但是, 与孔洞一样, 你需要调整算法, 使真实的小对象 (如灯具和门控点) 不会被删除。

* **光滑**
   * 空间映射可能会返回与实际对应项相比显得非常粗糙或 "干扰" 的表面。
   * 平滑度会影响物理学冲突: 如果地面为粗糙, 则物理模拟的高尔夫球可能不会以直线平滑地滚动。
   * 平滑度会影响呈现: 如果图面直接可视化, 则视觉表面的法线会影响其外观并干扰 "干净" 的外观。 可以通过使用着色器中用于呈现图面的适当照明和纹理来缓解这种情况。
   * 可以在 surface 网格中平滑粗糙度。 但是, 这可能会使表面远离相应的实际表面。 维护近函件对于生成准确的全息图封闭非常重要, 并使用户能够通过全息表面实现精确、可预测的交互。
   * 如果只需要修饰的更改, 则它可能足以使顶点法线平滑, 而不会改变顶点位置。

* **平面查找**
   * 应用程序可能希望在空间映射提供的图面上执行多种形式的分析。
   * 一个简单的示例是 "平面查找";标识图面上的边界、大多数平面区域。
   * 平面区域可用作全息的工作图面, 其中全息内容可由应用程序自动放置。
   * 平面区域可以限制用户界面, 指导用户与最适合其需求的图面进行交互。
   * 在现实世界中, 可以将平面区域用作可用于功能对象 (如液晶屏、表格或白板) 的全息物。
   * 平面区域可以定义播放区域, 形成 videogame 级别的基础。
   * 平面区域可以帮助虚拟代理浏览现实世界, 方法是确定真实人员可能会走到的地面区域。

## <a name="prototyping-and-debugging"></a>原型制作和调试

### <a name="useful-tools"></a>有用的工具
* [HoloLens 模拟器](using-the-hololens-emulator.md)可用于使用空间映射开发应用程序, 而无需访问物理 HoloLens。 它可让你在真实环境中模拟 HoloLens 上的实时会话, 并且应用程序通常会使用的所有数据, 包括 HoloLens 运动、空间坐标系统和空间映射网格。 这可用于提供可靠的可重复输入, 这对于调试问题和评估代码更改很有用。
* 若要重现方案, 请从实时 HoloLens 捕获网络上的空间映射数据, 然后将其保存到磁盘, 并在后续调试会话中重复使用。
* [Windows 设备门户三维视图](using-the-windows-device-portal.md#3d-view)提供了一种方法, 用于查看当前通过空间映射系统提供的所有空间图面。 这为应用程序内的空间曲面提供了比较基础;例如, 您可以轻松判断是否有任何空间图面丢失或是否显示在错误的位置。

### <a name="general-prototyping-guidance"></a>一般原型设计指南
* 由于空间映射数据中的[错误](spatial-mapping-design.md#what-influences-spatial-mapping-quality)可能会对用户体验造成很大的影响, 因此建议在各种环境中测试应用程序。
* 不要以始终在同一位置 (例如在办公桌) 上进行测试的习惯进行捕获。 请确保在不同位置、形状、大小和材料的各种曲面上进行测试。
* 同样, 尽管综合数据或记录的数据对于调试非常有用, 但不太依赖于相同的几个测试用例。 这可能会延迟查找更多测试会提前捕获的重要问题。
* 很好的做法是, 使用真实 (和理想的夺得) 用户执行测试, 因为它们不能使用 HoloLens 或您的应用程序, 其方式与使用方式完全相同。 事实上, 这可能会让您感到他人的行为、知识和假设是多么的呢？

## <a name="see-also"></a>请参阅
* [房间扫描可视化](room-scan-visualization.md)
* [空间音效设计](spatial-sound-design.md)
* [Unity 中的持久性](persistence-in-unity.md)
